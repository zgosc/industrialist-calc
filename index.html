<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrialist Factory Balancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        /* === COLOR & FONT BASICS === */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0A0A0A; 
            color: #D0D0D0;
        }
        
        /* Custom Scrollbar */
        .custom-scroll { overflow-y: auto; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { 
            background: #252525; 
            border-radius: 4px; 
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #3A3A3A; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .input-glow { transition: all 0.2s ease; }
        .input-glow:focus { transform: scale(1.05); z-index: 10; }

        /* --- COLUMN FLOW FIX --- */
        #workspace {
            column-gap: 2rem;
            padding: 2rem;
        }
        
        @media (min-width: 1536px) {
            #workspace { column-count: 2; }
        }
        @media (max-width: 1535px) {
            #workspace { column-count: 1; }
        }

        .recipe-card {
            display: inline-block;
            width: 100%;
            margin-bottom: 2rem;
            break-inside: avoid;
        }

        /* === ACCENT COLORS === */
        .wiki-input-accent-text { color: #E5C359; } 
        .wiki-secondary-accent-bg { background-color: #1691ce; }
        .wiki-secondary-accent-hover-bg:hover { background-color: #6A9DB8; }
        .wiki-secondary-accent-text { color: #3b94c0; }
        .wiki-secondary-accent-shadow { box-shadow: 0 10px 15px -3px rgba(123, 174, 200, 0.2); } 
    </style>
</head>
<body class="text-slate-200 h-screen flex flex-col overflow-hidden">

    <div class="shrink-0 bg-[#101010] border-b border-[#2A2A2A] z-20 shadow-xl">
        <div class="max-w-[1920px] mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <i data-lucide="conveyor" class="text-white w-7 h-7"></i> 
                    <div>
                        <h1 class="text-2xl font-bold text-white tracking-tight leading-none">Industrialist Factory Balancer</h1> 
                        <h5 class="text-slate-500">By Zgosc</h5> 
                    </div>
                </div>
                <button onclick="addRecipe()" class="flex items-center gap-2 wiki-secondary-accent-bg wiki-secondary-accent-hover-bg text-[#101010] px-6 py-3 rounded-lg font-bold shadow-lg shadow-black/40 transition-all hover:-translate-y-0.5 active:scale-95 text-sm">
                    <i data-lucide="plus" class="w-5 h-5"></i> New recipe
                </button>
            </div>
        </div>
    </div>

    <div class="flex-1 relative w-full bg-[#181818] custom-scroll">
        <div id="workspace" class="max-w-[1920px] mx-auto"> 
        </div>
    </div>

    <script>
        let recipes = [
            {
                id: Date.now(),
                name: "Untitled Recipe 1",
                targetTime: 1,
                ingredients: [
                    { id: 1, name: "Untitled Item", prodQty: 1, prodTime: 1, reqQty: 1 }
                ]
            }
        ];

        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);

        function calculatePerfectRatio(reqQty, reqTime, prodQty, prodTime) {
            let num = reqQty * prodTime;
            let den = reqTime * prodQty;
            
            let safety = 0;
            while ((Math.abs(num % 1) > 0.001 || Math.abs(den % 1) > 0.001) && safety < 10) {
                num *= 10; den *= 10; safety++;
            }
            
            num = Math.round(num);
            den = Math.round(den);

            if (num === 0 || den === 0) return { valid: false };

            const common = gcd(num, den);
            const finalProd = num / common;
            const finalCons = den / common;

            if (finalProd > 200 || finalCons > 200) return { valid: false, reason: "Complex" };

            return { valid: true, prod: finalProd, cons: finalCons };
        }

        function calculateAndUpdate(rId, iId, inputEl, field) {
            const value = Number(inputEl.value);
            const recipe = recipes.find(x => x.id === rId);
            if (!recipe) return;

            // 1. Update the state in memory first
            if (field === 'targetTime') {
                recipe.targetTime = value;
            } else {
                const ingredient = recipe.ingredients.find(i => i.id === iId);
                if (!ingredient) return;
                ingredient[field] = value;
            }

            // 2. Re-calculate and update ALL ingredient result badges on this recipe
            recipe.ingredients.forEach(ing => {
                const pRate = (ing.prodQty > 0 && ing.prodTime > 0) ? (ing.prodQty / ing.prodTime) : 0;
                const cRate = (ing.reqQty > 0 && recipe.targetTime > 0) ? (ing.reqQty / recipe.targetTime) : 0;
                
                let resultHtml = `<span class="opacity-20 font-mono text-sm">-</span>`;
                let ratioHtml = ``;

                if (pRate > 0 && cRate > 0) {
                    const needed = Math.ceil(cRate / pRate);
                    const ratio = calculatePerfectRatio(ing.reqQty, recipe.targetTime, ing.prodQty, ing.prodTime);
                    
                    // Machine Count HTML (Teal)
                    resultHtml = `
                        <div class="group/res relative flex justify-center w-full" title="The calculated number of producer machines required to meet your demand.">
                            <div class="bg-teal-700/10 border border-teal-700/30 text-teal-400 w-full py-2 rounded-lg flex items-center justify-center text-xl font-bold font-mono shadow-[0_0_15px_-3px_rgba(30,165,140,0.1)]">
                                ${needed} <span class="text-[10px] ml-1.5 opacity-50 uppercase mt-1">Mach</span>
                            </div>
                        </div>
                    `;

                    // Ratio HTML (Gold Accent for prod, Red for cons)
                    if (ratio.valid) {
                        ratioHtml = `
                            <div class="flex items-center gap-3 bg-[#101010]/50 px-3 py-1.5 rounded-lg border border-[#2A2A2A] w-full justify-center mt-2" 
                                title="Perfect ratio of Producers (${ratio.prod}) to Consumers (${ratio.cons}) for perfect alignment.">
                                <span class="wiki-input-accent-text font-bold font-mono text-sm">${ratio.prod}</span> 
                                <i data-lucide="arrow-right" class="w-3 h-3 text-slate-600"></i>
                                <span class="text-red-400 font-bold font-mono text-sm">${ratio.cons}</span> 
                            </div>
                        `;
                    } else {
                        ratioHtml = `
                            <div class="w-full text-center mt-2">
                                <span class="text-[10px] font-bold text-slate-600 bg-[#101010] px-3 py-1 rounded border border-[#2A2A2A]/50">Complex Ratio</span>
                            </div>
                        `;
                    }
                }
                
                // Find the corresponding result containers in the DOM and update them
                const resultContainer = document.getElementById(`result-${rId}-${ing.id}`);
                if (resultContainer) {
                    resultContainer.innerHTML = resultHtml + ratioHtml;
                    lucide.createIcons();
                }
            });
        }

        function render() {
            const container = document.getElementById('workspace');
            container.innerHTML = '';

            recipes.forEach((recipe) => {
                const card = document.createElement('div');
                card.className = 'recipe-card flex flex-col bg-[#181818] border border-[#2A2A2A] rounded-xl shadow-2xl overflow-hidden';
                
                let html = `
                    <div class="p-6 bg-[#101010] border-b border-[#2A2A2A] flex justify-between items-start gap-6">
                        <div class="flex-1">
                            <label class="text-xs font-bold wiki-secondary-accent-text uppercase tracking-widest mb-1 block">â €</label> 
                            <input type="text" value="${recipe.name}" 
                                class="bg-transparent text-2xl font-bold text-white border-none p-0 focus:ring-0 placeholder-slate-600 w-full"
                                onchange="updateRecipe(${recipe.id}, 'name', this.value)"
                                placeholder="Untitled Recipe"
                                title="you can change this name btw">
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="flex flex-col items-end">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Base Time</label>
                                <div class="flex items-stretch bg-[#101010] rounded-lg border border-[#2A2A2A] overflow-hidden"
                                    title="how many seconds it takes to produce for the consumer">
                                    <div class="px-3 py-2 bg-[#2A2A2A] flex items-center justify-center"> <i data-lucide="timer" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                    <input type="number" value="${recipe.targetTime}" 
                                        class="w-20 bg-transparent text-white font-mono text-center text-lg font-bold focus:outline-none p-1.5 flex-grow"
                                        oninput="calculateAndUpdate(${recipe.id}, null, this, 'targetTime')"
                                        onblur="render()"
                                        >
                                    <div class="pr-3 text-xs text-slate-500 font-bold flex items-center">s</div> </div>
                            </div>
                            
                            <button onclick="removeRecipe(${recipe.id})" class="h-10 w-10 flex items-center justify-center rounded-lg bg-[#2A2A2A] text-slate-400 hover:bg-red-500/10 hover:text-red-400 transition-all ml-2 border border-[#2A2A2A] hover:border-red-500/50"
                                title="get this recipe out my face!">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-4 px-6 py-4 bg-[#202020] text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-[#2A2A2A]/50">
                        <div class="col-span-4 pl-2">Resource Name</div>
                        <div class="col-span-4 text-center wiki-secondary-accent-text">Production Rate</div>
                        <div class="col-span-2 text-center text-red-400">Demand</div>
                        <div class="col-span-2 text-center text-teal-400">Results</div>
                    </div>

                    <div class="p-5 space-y-4">
                `;

                recipe.ingredients.forEach((ing) => {
                    const pRate = (ing.prodQty > 0 && ing.prodTime > 0) ? (ing.prodQty / ing.prodTime) : 0;
                    const cRate = (ing.reqQty > 0 && recipe.targetTime > 0) ? (ing.reqQty / recipe.targetTime) : 0;
                    
                    let resultBadge = `<span class="opacity-20 font-mono text-sm">-</span>`;
                    let ratioDisplay = ``;

                    if (pRate > 0 && cRate > 0) {
                        const needed = Math.ceil(cRate / pRate);
                        const ratio = calculatePerfectRatio(ing.reqQty, recipe.targetTime, ing.prodQty, ing.prodTime);
                        
                        // Machine Count HTML (Teal)
                        resultBadge = `
                            <div class="group/res relative flex justify-center w-full" 
                                title="How many producers ou need for one consumer">
                                <div class="bg-teal-700/10 border border-teal-700/30 text-teal-400 w-full py-2 rounded-lg flex items-center justify-center text-xl font-bold font-mono shadow-[0_0_15px_-3px_rgba(30,165,140,0.1)]">
                                    ${needed} <span class="text-[10px] ml-1.5 opacity-50 uppercase mt-1">Mach</span>
                                </div>
                            </div>
                        `;

                        if (ratio.valid) {
                            // Ratio Display - Producers (Gold Accent), Consumers (Red)
                            ratioDisplay = `
                                <div class="flex items-center gap-3 bg-[#101010]/50 px-3 py-1.5 rounded-lg border border-[#2A2A2A] w-full justify-center mt-2" 
                                    title="The most perfect ratio you could get (one could only dream)">
                                    <span class="wiki-input-accent-text font-bold font-mono text-sm">${ratio.prod}</span>
                                    <i data-lucide="arrow-right" class="w-3 h-3 text-slate-600"></i>
                                    <span class="text-red-400 font-bold font-mono text-sm">${ratio.cons}</span>
                                </div>
                            `;
                        } else {
                            ratioDisplay = `
                                <div class="w-full text-center mt-2">
                                    <span class="text-[10px] font-bold text-slate-600 bg-[#101010] px-3 py-1 rounded border border-[#2A2A2A]/50">Complex Ratio</span>
                                </div>
                            `;
                        }
                    }

                    html += `
                        <div class="relative grid grid-cols-12 gap-4 items-center bg-[#202020] border border-[#2A2A2A] rounded-xl p-4 hover:border-slate-500 transition-colors shadow-sm group">
                            
                            <div class="col-span-4 pl-2">
                                <div class="flex items-center justify-between">
                                    <input type="text" value="${ing.name}" 
                                        class="bg-transparent border-none text-white placeholder-slate-500 font-bold text-lg w-full p-0 focus:ring-0"
                                        onchange="updateIngredient(${recipe.id}, ${ing.id}, 'name', this.value)"
                                        placeholder="Untitled Item"
                                        title="you can change this btw">
                                    <button onclick="removeIngredient(${recipe.id}, ${ing.id})" class="text-slate-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2"
                                        title="annihilate this ingriedient">
                                        <i data-lucide="trash" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-span-4">
                                <div class="flex items-stretch bg-[#101010]/50 rounded-lg border border-[#2A2A2A] overflow-hidden ring-0 focus-within:ring-1 focus-within:ring-sky-500/50 transition-all h-14">
                                    
                                    <div class="relative flex-1 group/in border-r border-[#2A2A2A]"
                                        title="how many items this machine produces in a cycle">
                                        <input type="number" value="${ing.prodQty}" 
                                            class="w-full h-full bg-transparent wiki-input-accent-text font-mono font-bold text-xl text-center focus:outline-none input-glow"
                                            oninput="calculateAndUpdate(${recipe.id}, ${ing.id}, this, 'prodQty')"
                                            onblur="render()"
                                            >
                                        <div class="absolute top-1.5 left-2 text-[9px] font-bold wiki-input-accent-text pointer-events-none uppercase tracking-wider">Items</div>
                                    </div>

                                    <div class="flex flex-col justify-center bg-[#2A2A2A]/30 px-2">
                                        <span class="text-[10px] font-bold text-slate-500">PER</span>
                                    </div>

                                    <div class="relative flex-1 border-l border-[#2A2A2A]"
                                        title="how many seconds it takes to produce an item">
                                        <input type="number" value="${ing.prodTime}" 
                                            class="w-full h-full bg-transparent text-sky-400 font-mono font-bold text-xl text-center focus:outline-none input-glow"
                                            oninput="calculateAndUpdate(${recipe.id}, ${ing.id}, this, 'prodTime')"
                                            onblur="render()"
                                            >
                                        <div class="absolute bottom-1.5 right-2 text-[9px] font-bold text-sky-500/30 pointer-events-none uppercase tracking-wider">Seconds</div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-span-2 flex justify-center">
                                <div class="relative w-full max-w-[90px]"
                                    title="how many of these items do you need for the consumer in a cycle">
                                    <input type="number" value="${ing.reqQty}" 
                                        class="w-full bg-[#101010] border border-red-700/30 rounded-lg py-3 text-center text-red-300 font-mono font-bold text-xl focus:border-red-700 focus:outline-none focus:ring-1 focus:ring-red-700 input-glow"
                                        oninput="calculateAndUpdate(${recipe.id}, ${ing.id}, this, 'reqQty')"
                                        onblur="render()"
                                        >
                                    <span class="absolute -top-2.5 left-1/2 -translate-x-1/2 bg-[#202020] px-1 text-[9px] text-red-500 font-bold uppercase tracking-wider">Need</span>
                                </div>
                            </div>

                            <div id="result-${recipe.id}-${ing.id}" class="col-span-2 flex flex-col justify-center items-center">
                                ${resultBadge}
                                ${ratioDisplay}
                            </div>
                        </div>
                    `;
                });

                html += `
                        <button onclick="addIngredient(${recipe.id})" class="w-full py-4 border border-dashed border-[#2A2A2A] text-slate-500 rounded-xl hover:border-sky-500/50 hover:text-sky-400 hover:bg-sky-500/5 transition-all text-sm font-bold uppercase tracking-widest flex items-center justify-center gap-2 mt-2"
                            title="Add a new ingredient">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Ingredient
                        </button>
                    </div>
                `;

                card.innerHTML = html;
                container.appendChild(card);
            });

            lucide.createIcons();
        }

        function updateRecipe(rId, field, value) {
            const r = recipes.find(x => x.id === rId);
            if(r) { 
                r.name = value; 
            }
        }
        
        function addRecipe() {
            const newIndex = recipes.length + 1;
            recipes.push({
                id: Date.now(),
                name: `Untitled  Recipe${newIndex}`,
                targetTime: 1,
                ingredients: [{ id: Date.now()+1, name: "Untitled Item", prodQty: 1, prodTime: 1, reqQty: 1 }]
            });
            render();
        }

        function removeRecipe(rId) {
            recipes = recipes.filter(r => r.id !== rId);
            render();
        }

        function addIngredient(rId) {
            const r = recipes.find(x => x.id === rId);
            if(r) {
                r.ingredients.push({ id: Date.now(), name: "Untitled Item", prodQty: 1, prodTime: 1, reqQty: 1 });
                render();
            }
        }

        function removeIngredient(rId, iId) {
            const r = recipes.find(x => x.id === rId);
            if(r) {
                r.ingredients = r.ingredients.filter(i => i.id !== iId);
                render();
            }
        }

        render();
    </script>
</body>
</html>